---
import Header from "./Header.astro";
import Hero from "./Hero.astro";
import CalloutSection from "./CalloutSection.astro";
import HoverGif from "./HoverGif.astro";
import Footer from "./Footer.astro";
import tvFrame from "../assets/retrotelevision.png";
import retroCatBoom from "../assets/retrocatboom.png";
import catPlayGif from "../assets/cattyping.gif";
import catSleepGif from "../assets/catsleeping.gif";
import "../styles/landing.css";

const panelConfigs = [
  {
    id: "start",
    variant: "tutorial",
    eyebrow: "STUCK IN TUTORIAL HELL?",
    body: [
      { content: "You've watched 999 hours of JavaScript tutorials..." },
      {
        content: `but still can't <span class="tutorial-banner__accent">CENTER A DIV.</span>`,
        modifier: "tutorial-banner__body--tight",
      },
    ],
    footer: {
      href: "#solution",
      content: "oh no. ??",
    },
  },
  {
    id: "solution",
    variant: "solution",
    eyebrow: "SOLUTION",
    body: [
      { content: "Embrace the chaos." },
      {
        content: `Welcome to <span>VIBE CODING.</span>`,
        modifier: "solution-banner__body--accent",
      },
    ],
    footer: {
      href: "#stop-watching",
      content: "but like how? ??",
    },
  },
  {
    id: "stop-watching",
    variant: "stop",
    eyebrow: "STOP WATCHING",
    body: [
      {
        content: `Tutorials you'll forget <span class="stop-banner__accent">TOMORROW.</span>`,
      },
    ],
    footer: {
      href: "#start-building",
      content: "what? why? ??",
    },
  },
  {
    id: "start-building",
    variant: "build",
    eyebrow: "START BUILDING",
    body: [
      {
        content: `Stuff that <span class="build-banner__accent">BARELY WORKS</span> &mdash; and fix it live.`,
      },
      {
        content: `Learn coding fundamentals by <span class="build-banner__accent">BREAKING THEM.</span>`,
        modifier: "build-banner__body--accent",
      },
    ],
    footer: {
      href: "#have-fun",
      content: "is that possible? ??",
    },
  },
  {
    id: "have-fun",
    variant: "fun",
    eyebrow: "HAVE FUN",
    body: [
      {
        content: `Stop learning. <span class="fun-banner__accent">START DOING.</span>`,
      },
      { content: "Make weird stuff that works!" },
    ],
    footer: {
      href: "#blogs",
      content: "hell yeah! ??",
    },
  },
];

const tvFrameSrc = typeof tvFrame === "string" ? tvFrame : tvFrame?.src ?? tvFrame;
const retroCatSrc =
  typeof retroCatBoom === "string" ? retroCatBoom : retroCatBoom?.src ?? retroCatBoom;
const catPlaySrc =
  typeof catPlayGif === "string" ? catPlayGif : catPlayGif?.src ?? catPlayGif;
const catSleepSrc =
  typeof catSleepGif === "string" ? catSleepGif : catSleepGif?.src ?? catSleepGif;
---
<div id="landing-page" class="page">
  <Header />
  <Hero tvFrameSrc={tvFrameSrc} retroCatSrc={retroCatSrc} />
  {panelConfigs.map((panel) => (
    <CalloutSection config={panel} />
  ))}
  <HoverGif catPlaySrc={catPlaySrc} catSleepSrc={catSleepSrc} />
  <Footer />
</div>
<script is:inline>
  (() => {
    const page = document.getElementById("landing-page");
    if (!page) return;

    const tvImage = page.querySelector(".hero-visual .tv");
    if (tvImage instanceof HTMLImageElement) {
      const defaultSrc = tvImage.dataset.defaultSrc || tvImage.currentSrc || tvImage.src;
      const defaultAlt = tvImage.dataset.defaultAlt || tvImage.alt;
      const altSrc = tvImage.dataset.altSrc;
      const altAlt = tvImage.dataset.altAlt || defaultAlt;

      if (altSrc) {
        let isAlt = false;
        const applyState = (showAlternate) => {
          tvImage.src = showAlternate ? altSrc : defaultSrc;
          tvImage.alt = showAlternate ? altAlt : defaultAlt;
          tvImage.setAttribute("aria-pressed", showAlternate ? "true" : "false");
        };

        const toggleImage = () => {
          isAlt = !isAlt;
          applyState(isAlt);
        };

        tvImage.addEventListener("click", (event) => {
          event.preventDefault();
          toggleImage();
        });

        tvImage.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            toggleImage();
          }
        });
      }
    }

    const triggers = Array.from(page.querySelectorAll(".hover-gif-trigger"));
    const hoverGif = page.querySelector("#hover-gif");
    const hoverGifImage = hoverGif?.querySelector("img");

    if (triggers.length && hoverGif && hoverGifImage) {
      const gifSources = {
        play: hoverGif.dataset.gifPlay || hoverGifImage.src,
        sleep: hoverGif.dataset.gifSleep || hoverGifImage.src,
      };

      let gifWidth = 0;
      let gifHeight = 0;
      let lastTrigger = null;
      let pendingFrame = 0;

      const measureGif = () => {
        gifWidth =
          hoverGifImage.offsetWidth ||
          hoverGifImage.naturalWidth ||
          gifWidth;
        gifHeight =
          hoverGifImage.offsetHeight ||
          hoverGifImage.naturalHeight ||
          gifHeight;
      };

      if (hoverGifImage.complete) {
        measureGif();
      } else {
        hoverGifImage.addEventListener("load", measureGif, { once: true });
      }

      const positionAboveHighlight = (event, { lockY = false } = {}) => {
        if (!gifWidth || !gifHeight) measureGif();
        const currentTarget =
          event && event.currentTarget instanceof HTMLElement
            ? event.currentTarget
            : null;
        const target = currentTarget || lastTrigger;
        const rect = target?.getBoundingClientRect();
        const clientX =
          (event && typeof event.clientX === "number" && event.clientX) ??
          (rect ? rect.left + rect.width / 2 : window.innerWidth / 2);
        const clientY = lockY
          ? null
          : (event && typeof event.clientY === "number" && event.clientY) ??
            rect?.top ??
            window.innerHeight / 2;
        const x = clientX - gifWidth / 2;
        const fallbackY = rect ? rect.top - gifHeight + 50 : hoverGif.offsetTop;
        const y = clientY !== null ? clientY - gifHeight + 50 : fallbackY;
        hoverGif.style.transform = `translate3d(${x}px, ${y}px, 0)`;
      };

      const updateGif = (event) => {
        const trigger = event.currentTarget;
        if (!(trigger instanceof HTMLElement)) return;

        const gifKey = trigger.dataset.gif;
        const nextSrc = gifKey ? gifSources[gifKey] : null;
        if (nextSrc && hoverGifImage.src !== nextSrc) {
          hoverGifImage.src = nextSrc;
        }
      };

      const showGif = (event) => {
        const trigger = event.currentTarget;
        if (!(trigger instanceof HTMLElement)) return;
        lastTrigger = trigger;
        updateGif(event);
        positionAboveHighlight(event);
        hoverGif.classList.add("visible");
        hoverGif.setAttribute("aria-hidden", "false");
      };

      const hideGif = () => {
        lastTrigger = null;
        hoverGif.classList.remove("visible");
        hoverGif.setAttribute("aria-hidden", "true");
      };

      const handleMouseMove = (event) => {
        if (!hoverGif.classList.contains("visible")) return;
        pendingFrame = pendingFrame || requestAnimationFrame(() => {
          pendingFrame = 0;
          positionAboveHighlight(event, { lockY: true });
        });
      };

      const handleViewportChange = () => {
        if (!hoverGif.classList.contains("visible")) return;
        positionAboveHighlight(null);
      };

      triggers.forEach((trigger) => {
        trigger.addEventListener("mouseenter", showGif);
        trigger.addEventListener("mouseleave", hideGif);
        trigger.addEventListener("focus", showGif);
        trigger.addEventListener("blur", hideGif);
      });

      window.addEventListener("mousemove", handleMouseMove);
      window.addEventListener("resize", handleViewportChange);
      window.addEventListener("scroll", handleViewportChange, { passive: true });
    }

    const revealSections = Array.from(
      page.querySelectorAll(".reveal-on-scroll")
    );

    if (revealSections.length) {
      const applyDelays = (section) => {
        const revealItems = section.querySelectorAll("[data-reveal-order]");
        revealItems.forEach((item, index) => {
          const orderAttr = item.dataset.revealOrder;
          const order = orderAttr ? parseFloat(orderAttr) : index + 1;
          const delay = Math.max(order * 0.12 - 0.05, 0);
          item.style.setProperty("--reveal-delay", `${delay}s`);
        });
      };

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            const section = entry.target;
            applyDelays(section);
            if (entry.isIntersecting) {
              section.classList.add("is-visible");
            } else {
              section.classList.remove("is-visible");
            }
          });
        },
        {
          threshold: 0.3,
          rootMargin: "0px 0px -20% 0px",
        }
      );

      revealSections.forEach((section) => {
        applyDelays(section);
        observer.observe(section);
      });
    }
  })();
</script>
