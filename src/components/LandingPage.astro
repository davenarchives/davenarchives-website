---
import Header from "./Header.astro";
import Hero from "./Hero.astro";
import CalloutSection from "./CalloutSection.astro";
import HoverGif from "./HoverGif.astro";
import Footer from "./Footer.astro";
import tvFrame from "../assets/retrotelevision.png";
import retroCatBoom from "../assets/retrocatboom.png";
import catPlayGif from "../assets/cattyping.gif";
import catSleepGif from "../assets/catsleeping.gif";
import centerDivGif from "../assets/centerdiv.gif";
import vibeGif from "../assets/vibe.gif";
import tomorrowGif from "../assets/tomorrow.gif";
import barelyWorksGif from "../assets/barelyworks.gif";
import breakingThemGif from "../assets/breakingthem.gif";
import haveFunGif from "../assets/havefun.gif";
import "../styles/landing.css";

const panelConfigs = [
  {
    id: "start",
    variant: "tutorial",
    eyebrow: "STUCK IN TUTORIAL HELL?",
    body: [
      { content: "You've watched 999 hours of JavaScript tutorials..." },
      {
        content: `but still can't <span class="tutorial-banner__accent hover-gif-trigger" data-gif="center">CENTER A DIV.</span>`,
        modifier: "tutorial-banner__body--tight",
      },
    ],
    footer: {
      href: "#solution",
      content: "oh no. ðŸ˜¢",
    },
  },
  {
    id: "solution",
    variant: "solution",
    eyebrow: "SOLUTION",
    body: [
      { content: "Embrace the chaos." },
      {
        content: `Welcome to <span class="hover-gif-trigger" data-gif="vibe">VIBE CODING.</span>`,
        modifier: "solution-banner__body--accent",
      },
    ],
    footer: {
      href: "#stop-watching",
      content: "but like how? ðŸ¤”",
    },
  },
  {
    id: "stop-watching",
    variant: "stop",
    eyebrow: "STOP WATCHING",
    body: [
      {
        content: `Tutorials you'll forget <span class="stop-banner__accent hover-gif-trigger" data-gif="tomorrow" data-gif-width="290" data-gif-offset="26">TOMORROW.</span>`,
      },
    ],
    footer: {
      href: "#start-building",
      content: "what? why? ðŸ¤¨",
    },
  },
  {
    id: "start-building",
    variant: "build",
    eyebrow: "START BUILDING",
    body: [
      {
        content: `Stuff that <span class="build-banner__accent hover-gif-trigger" data-gif="barely" data-gif-width="260" data-gif-offset="24">BARELY WORKS</span> &mdash; and fix it live.`,
      },
      {
        content: `Learn coding fundamentals by <span class="build-banner__accent hover-gif-trigger" data-gif="breaking" data-gif-width="250" data-gif-offset="44">BREAKING THEM.</span>`,
        modifier: "build-banner__body--accent",
      },
    ],
    footer: {
      href: "#have-fun",
      content: "is that possible? ðŸ˜³",
    },
  },
  {
    id: "have-fun",
    variant: "fun",
    eyebrow: "HAVE FUN",
    body: [
      {
        content: `Stop learning. <span class="fun-banner__accent hover-gif-trigger" data-gif="havefun" data-gif-width="280" data-gif-offset="34">START DOING.</span>`,
      },
      { content: "Make weird stuff that works!" },
    ],
    footer: {
      href: "#blogs",
      content: "hell yeah! ðŸ˜Ž",
    },
  },
];

const tvFrameSrc = typeof tvFrame === "string" ? tvFrame : tvFrame?.src ?? tvFrame;
const retroCatSrc =
  typeof retroCatBoom === "string" ? retroCatBoom : retroCatBoom?.src ?? retroCatBoom;
const catPlaySrc =
  typeof catPlayGif === "string" ? catPlayGif : catPlayGif?.src ?? catPlayGif;
const catSleepSrc =
  typeof catSleepGif === "string" ? catSleepGif : catSleepGif?.src ?? catSleepGif;
const centerGifSrc =
  typeof centerDivGif === "string" ? centerDivGif : centerDivGif?.src ?? centerDivGif;
const vibeGifSrc =
  typeof vibeGif === "string" ? vibeGif : vibeGif?.src ?? vibeGif;
const tomorrowGifSrc =
  typeof tomorrowGif === "string" ? tomorrowGif : tomorrowGif?.src ?? tomorrowGif;
const barelyWorksGifSrc =
  typeof barelyWorksGif === "string"
    ? barelyWorksGif
    : barelyWorksGif?.src ?? barelyWorksGif;
const breakingThemGifSrc =
  typeof breakingThemGif === "string"
    ? breakingThemGif
    : breakingThemGif?.src ?? breakingThemGif;
const haveFunGifSrc =
  typeof haveFunGif === "string" ? haveFunGif : haveFunGif?.src ?? haveFunGif;
---
<div id="landing-page" class="page">
  <Header />
  <Hero tvFrameSrc={tvFrameSrc} retroCatSrc={retroCatSrc} />
  {panelConfigs.map((panel) => (
    <CalloutSection config={panel} />
  ))}
  <HoverGif
    catPlaySrc={catPlaySrc}
    catSleepSrc={catSleepSrc}
    centerGifSrc={centerGifSrc}
    vibeGifSrc={vibeGifSrc}
    tomorrowGifSrc={tomorrowGifSrc}
    barelyWorksGifSrc={barelyWorksGifSrc}
    breakingThemGifSrc={breakingThemGifSrc}
    haveFunGifSrc={haveFunGifSrc}
  />
  <Footer />
</div>
<script is:inline>
  (() => {
    const page = document.getElementById("landing-page");
    if (!page) return;

    const tvImage = page.querySelector(".hero-visual .tv");
    if (tvImage instanceof HTMLImageElement) {
      const defaultSrc = tvImage.dataset.defaultSrc || tvImage.currentSrc || tvImage.src;
      const defaultAlt = tvImage.dataset.defaultAlt || tvImage.alt;
      const altSrc = tvImage.dataset.altSrc;
      const altAlt = tvImage.dataset.altAlt || defaultAlt;

      if (altSrc) {
        let isAlt = false;
        const applyState = (showAlternate) => {
          tvImage.src = showAlternate ? altSrc : defaultSrc;
          tvImage.alt = showAlternate ? altAlt : defaultAlt;
          tvImage.setAttribute("aria-pressed", showAlternate ? "true" : "false");
        };

        const toggleImage = () => {
          isAlt = !isAlt;
          applyState(isAlt);
        };

        tvImage.addEventListener("click", (event) => {
          event.preventDefault();
          toggleImage();
        });

        tvImage.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            toggleImage();
          }
        });
      }
    }

    const triggers = Array.from(page.querySelectorAll(".hover-gif-trigger"));
    const hoverGif = page.querySelector("#hover-gif");
    const hoverGifImage = hoverGif?.querySelector("img");

    if (triggers.length && hoverGif && hoverGifImage) {
      const gifSources = {
        play: hoverGif.dataset.gifPlay || hoverGifImage.src,
        sleep: hoverGif.dataset.gifSleep || hoverGifImage.src,
        center: hoverGif.dataset.gifCenter || hoverGifImage.src,
        vibe: hoverGif.dataset.gifVibe || hoverGifImage.src,
        tomorrow: hoverGif.dataset.gifTomorrow || hoverGifImage.src,
        barely: hoverGif.dataset.gifBarely || hoverGifImage.src,
        breaking: hoverGif.dataset.gifBreaking || hoverGifImage.src,
        havefun: hoverGif.dataset.gifHavefun || hoverGifImage.src,
      };

      let gifWidth = 0;
      let gifHeight = 0;
      let lastTrigger = null;
      let pendingFrame = 0;
      const defaultOffset = 12;
      const defaultWidth = 240;
      let currentOffset = defaultOffset;
      hoverGif.style.setProperty("--hover-gif-width", `${defaultWidth}px`);

      const measureGif = () => {
        gifWidth =
          hoverGifImage.offsetWidth ||
          hoverGifImage.naturalWidth ||
          gifWidth;
        gifHeight =
          hoverGifImage.offsetHeight ||
          hoverGifImage.naturalHeight ||
          gifHeight;
      };

      const applyWidth = (widthValue) => {
        const resolvedWidth =
          typeof widthValue === "number" && Number.isFinite(widthValue)
            ? widthValue
            : defaultWidth;
        hoverGif.style.setProperty("--hover-gif-width", `${resolvedWidth}px`);
        measureGif();
      };

      if (hoverGifImage.complete) {
        measureGif();
      } else {
        hoverGifImage.addEventListener("load", measureGif, { once: true });
      }

      const positionAboveHighlight = (event, { lockY = false } = {}) => {
        if (!gifWidth || !gifHeight) measureGif();
        const currentTarget =
          event && event.currentTarget instanceof HTMLElement
            ? event.currentTarget
            : null;
        const target = currentTarget || lastTrigger;
        const rect = target?.getBoundingClientRect();
        const clientX =
          (event && typeof event.clientX === "number" && event.clientX) ??
          (rect ? rect.left + rect.width / 2 : window.innerWidth / 2);
        const clientY = lockY
          ? null
          : (event && typeof event.clientY === "number" && event.clientY) ??
            rect?.top ??
            window.innerHeight / 2;
        const x = clientX - gifWidth / 2;
        const verticalOffset = currentOffset;
        const baseTop =
          rect?.top ??
          (clientY !== null ? clientY : window.innerHeight / 2);
        const y = baseTop - gifHeight + verticalOffset;
        hoverGif.style.transform = `translate3d(${x}px, ${y}px, 0)`;
      };

      const updateGif = (event) => {
        const trigger = event.currentTarget;
        if (!(trigger instanceof HTMLElement)) return;

        const gifKey = trigger.dataset.gif;
        const nextSrc = gifKey ? gifSources[gifKey] : null;
        if (nextSrc && hoverGifImage.src !== nextSrc) {
          const handleLoad = () => {
            measureGif();
            if (hoverGif.classList.contains("visible")) {
              positionAboveHighlight(null);
            }
          };
          hoverGifImage.addEventListener("load", handleLoad, { once: true });
          hoverGifImage.src = nextSrc;
        } else {
          measureGif();
        }
      };

      const showGif = (event) => {
        const trigger = event.currentTarget;
        if (!(trigger instanceof HTMLElement)) return;
        lastTrigger = trigger;
        const widthAttr = trigger.dataset.gifWidth;
        const offsetAttr = trigger.dataset.gifOffset;
        const parsedWidth =
          typeof widthAttr === "string" ? parseFloat(widthAttr) : NaN;
        const parsedOffset =
          typeof offsetAttr === "string" ? parseFloat(offsetAttr) : NaN;
        currentOffset = Number.isFinite(parsedOffset)
          ? parsedOffset
          : defaultOffset;
        applyWidth(Number.isFinite(parsedWidth) ? parsedWidth : null);
        updateGif(event);
        positionAboveHighlight(event);
        hoverGif.classList.add("visible");
        hoverGif.setAttribute("aria-hidden", "false");
      };

      const hideGif = () => {
        lastTrigger = null;
        currentOffset = defaultOffset;
        hoverGif.classList.remove("visible");
        hoverGif.setAttribute("aria-hidden", "true");
      };

      const handleMouseMove = (event) => {
        if (!hoverGif.classList.contains("visible")) return;
        pendingFrame = pendingFrame || requestAnimationFrame(() => {
          pendingFrame = 0;
          positionAboveHighlight(event, { lockY: true });
        });
      };

      const handleViewportChange = () => {
        if (!hoverGif.classList.contains("visible")) return;
        positionAboveHighlight(null);
      };

      triggers.forEach((trigger) => {
        trigger.addEventListener("mouseenter", showGif);
        trigger.addEventListener("mouseleave", hideGif);
        trigger.addEventListener("focus", showGif);
        trigger.addEventListener("blur", hideGif);
      });

      window.addEventListener("mousemove", handleMouseMove);
      window.addEventListener("resize", handleViewportChange);
      window.addEventListener("scroll", handleViewportChange, { passive: true });
    }

    const revealSections = Array.from(
      page.querySelectorAll(".reveal-on-scroll")
    );

    if (revealSections.length) {
      const applyDelays = (section) => {
        const revealItems = section.querySelectorAll("[data-reveal-order]");
        revealItems.forEach((item, index) => {
          const orderAttr = item.dataset.revealOrder;
          const order = orderAttr ? parseFloat(orderAttr) : index + 1;
          const delay = Math.max(order * 0.12 - 0.05, 0);
          item.style.setProperty("--reveal-delay", `${delay}s`);
        });
      };

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            const section = entry.target;
            applyDelays(section);
            if (entry.isIntersecting) {
              section.classList.add("is-visible");
            } else {
              section.classList.remove("is-visible");
            }
          });
        },
        {
          threshold: 0.3,
          rootMargin: "0px 0px -20% 0px",
        }
      );

      revealSections.forEach((section) => {
        applyDelays(section);
        observer.observe(section);
      });
    }
  })();
</script>










