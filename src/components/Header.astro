---
import ThemeToggle from "./ThemeToggle.astro";

const { active } = Astro.props ?? {};
---
<header class="site-header">
  <a class="logo" href="/" aria-label="Go to home">
    <svg
      class="logo-mark"
      viewBox="0 0 48 48"
      xmlns="http://www.w3.org/2000/svg"
      aria-hidden="true"
    >
      <path
        d="M6 17h36l-18-9-18 9zm6 3v15h6V20h-6zm10 0 v15 h4V20h-4zm8 0 v15 h6V20h-6z M8 38 v-3 h32 v3 H8z"
        fill="#f8b318"
      />
    </svg>
    <span class="logo-type">DAVENARCHIVES</span>
  </a>
  <nav class="site-nav">
    <a
      href="/projects"
      class={active === "projects" ? "is-active" : undefined}
      aria-current={active === "projects" ? "page" : undefined}
    >
      projects
    </a>
    <a
      href="/blogs"
      class={active === "blogs" ? "is-active" : undefined}
      aria-current={active === "blogs" ? "page" : undefined}
    >
      blogs
    </a>
    <div class="site-nav__actions">
      <label class="search" data-global-search-panel>
        <svg
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
        >
          <path
            d="M15.5 15.5L21 21"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
          />
          <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2" />
        </svg>
        <input
          type="search"
          placeholder="Search"
          data-global-search-input
          autocomplete="off"
          spellcheck="false"
        />
      </label>
      <ThemeToggle />
    </div>
  </nav>
</header>
<script>
  (() => {
    const searchPanel = document.querySelector("[data-global-search-panel]");
    const searchInput = searchPanel?.querySelector("[data-global-search-input]");
    if (!searchInput) return;

    const STORAGE_KEY = "globalSearchQuery";
    const dispatchQuery = (value) => {
      window.dispatchEvent(
        new CustomEvent("global-search-change", {
          detail: { value },
        })
      );
    };

    const readStored = () => {
      try {
        return localStorage.getItem(STORAGE_KEY) || "";
      } catch {
        return "";
      }
    };

    const writeStored = (value) => {
      try {
        localStorage.setItem(STORAGE_KEY, value);
      } catch {
        /* ignore */
      }
    };

    const syncFromStorage = () => {
      const saved = readStored();
      if (saved && searchInput.value !== saved) {
        searchInput.value = saved;
      }
      dispatchQuery(searchInput.value);
    };

    const handleInput = () => {
      const value = searchInput.value;
      writeStored(value);
      dispatchQuery(value);
    };

    searchInput.addEventListener("input", handleInput);
    searchInput.addEventListener("search", handleInput);
    searchInput.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        if (searchInput.value.trim().length > 0) {
          searchInput.value = "";
          handleInput();
        } else {
          searchInput.blur();
        }
      }
    });

    syncFromStorage();
  })();
</script>
