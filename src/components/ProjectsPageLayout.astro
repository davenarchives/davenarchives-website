---
import Header from "./Header.astro";
import Footer from "./Footer.astro";
import BackToTop from "./BackToTop.astro";
import SiteHead from "./SiteHead.astro";
import type { ProjectsPageData } from "../data/projects";
import { projectsPerPage } from "../data/projects";
import "../styles/landing.css";
import "../styles/projects.css";

export interface PaginationLink {
  pageNumber: number;
  href: string;
  isActive: boolean;
}

export interface Props {
  pageData: ProjectsPageData;
  paginationLinks: PaginationLink[];
  firstHref: string;
  prevHref: string;
  nextHref: string;
  lastHref: string;
  isFirstPage: boolean;
  isLastPage: boolean;
}

const {
  pageData,
  paginationLinks,
  firstHref,
  prevHref,
  nextHref,
  lastHref,
  isFirstPage,
  isLastPage,
} = Astro.props;

const { currentPage, projects } = pageData;
---

<html lang="en">
  <head>
    <SiteHead title="projects | davenarchives" />
  </head>
  <body>
    <div class="page projects-page">
      <Header active="projects" />
      <main class="projects-content">
        <header class="projects-header">
          <h1>PROJECTS</h1>
          <p>projects I developed or worked on with others</p>
        </header>
        <section class="projects-grid" aria-label="Project list">
          {projects.map((project, index) => {
          if (project.type === "featured") {
            const imageMeta = project.image;
            const cardContent = (
              <>
                <div class="project-card__media" role="presentation">
                  <img
                    src={imageMeta.src}
                    alt={`${project.title} project preview`}
                    loading="lazy"
                    width={imageMeta.width ?? 1024}
                    height={imageMeta.height ?? 768}
                  />
                </div>
                <div class="project-card__body">
                  <h2 id={`${project.id}-title`}>{project.title}</h2>
                  <p>{project.description}</p>
                  <ul class="project-card__tags" aria-label="Technology tags">
                    {project.tags.map((tag) => (
                      <li>
                        <span data-project-tag={tag}>#{tag}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              </>
            );

            return (
              <article
                class="project-card project-card--featured"
                aria-labelledby={`${project.id}-title`}
                data-project-id={project.id}
                data-project-title={project.title}
                data-project-description={project.description}
                data-project-tags={project.tags.join("|")}
              >
                {project.href ? (
                  <a
                    class="project-card__link"
                    href={project.href}
                    aria-label={`View details for ${project.title}`}
                  >
                    {cardContent}
                  </a>
                ) : (
                  cardContent
                )}
              </article>
            );
          }

            const placeholderPosition =
              index + 1 + (currentPage - 1) * projectsPerPage;

            return (
              <article
                class="project-card project-card--placeholder"
                aria-label={`Project placeholder ${placeholderPosition}`}
              >
                <div class="project-card__placeholder">
                  <span>coming soon</span>
                </div>
              </article>
            );
          })}
        </section>
        <p
          class="projects-search__no-results"
          data-project-search-results-empty
          hidden
        >
          No projects match that search. Try a different keyword or clear the
          search bar.
        </p>
        <nav class="projects-pagination" aria-label="Projects pages">
          <ul>
            <li>
              <a
                class={`projects-pagination__link projects-pagination__link--icon${
                  isFirstPage ? " projects-pagination__link--disabled" : ""
                }`}
                href={firstHref}
                aria-label="First page"
                aria-disabled={isFirstPage ? "true" : undefined}
                tabindex={isFirstPage ? "-1" : undefined}
              >
                &laquo;&laquo;
              </a>
            </li>
            <li>
              <a
                class={`projects-pagination__link projects-pagination__link--icon${
                  isFirstPage ? " projects-pagination__link--disabled" : ""
                }`}
                href={prevHref}
                aria-label="Previous page"
                aria-disabled={isFirstPage ? "true" : undefined}
                tabindex={isFirstPage ? "-1" : undefined}
              >
                &laquo;
              </a>
            </li>
            {paginationLinks.map((link) => (
              <li>
                <a
                  class={`projects-pagination__link${
                    link.isActive ? " projects-pagination__link--active" : ""
                  }`}
                  href={link.href}
                  aria-current={link.isActive ? "page" : undefined}
                >
                  {link.pageNumber}
                </a>
              </li>
            ))}
            <li>
              <a
                class={`projects-pagination__link projects-pagination__link--icon${
                  isLastPage ? " projects-pagination__link--disabled" : ""
                }`}
                href={nextHref}
                aria-label="Next page"
                aria-disabled={isLastPage ? "true" : undefined}
                tabindex={isLastPage ? "-1" : undefined}
              >
                &raquo;
              </a>
            </li>
            <li>
              <a
                class={`projects-pagination__link projects-pagination__link--icon${
                  isLastPage ? " projects-pagination__link--disabled" : ""
                }`}
                href={lastHref}
                aria-label="Last page"
                aria-disabled={isLastPage ? "true" : undefined}
                tabindex={isLastPage ? "-1" : undefined}
              >
                &raquo;&raquo;
              </a>
            </li>
          </ul>
        </nav>
      </main>
      <Footer />
      <BackToTop />
    </div>
    <script>
      (() => {
        const emptyResults = document.querySelector(
          "[data-project-search-results-empty]"
        );

        const grid = document.querySelector(".projects-grid");
        const featuredCards = Array.from(
          document.querySelectorAll(".project-card--featured")
        ).map((card) => {
          const tags = (card.dataset.projectTags || "")
            .split("|")
            .map((tag) => tag.trim().toLowerCase())
            .filter(Boolean);
          return {
            element: card,
            title: (card.dataset.projectTitle || "").toLowerCase(),
            description: (card.dataset.projectDescription || "").toLowerCase(),
            tags,
          };
        });

        const placeholderCards = Array.from(
          document.querySelectorAll(".project-card--placeholder")
        );
        const tagElements = Array.from(
          document.querySelectorAll("[data-project-tag]")
        ).map((element) => ({
          element,
          value: (element.dataset.projectTag || "").toLowerCase(),
        }));

        const updateTagHighlights = (trimmedValue = "") => {
          const normalized = trimmedValue.replace(/^#/, "").toLowerCase();
          tagElements.forEach(({ element, value }) => {
            element.classList.toggle(
              "project-tag--highlight",
              Boolean(normalized) && value === normalized
            );
          });
        };

        const applyFilter = (rawValue = "") => {
          const trimmed = rawValue.trim();
          const isTagMode = trimmed.startsWith("#");
          const normalized = isTagMode
            ? trimmed.slice(1).toLowerCase()
            : trimmed.toLowerCase();
          const isFiltering = Boolean(normalized);
          let visibleCount = 0;

          updateTagHighlights(trimmed);

          featuredCards.forEach((project) => {
            let matches = true;
            if (isFiltering) {
              if (isTagMode) {
                matches = project.tags.some((tag) =>
                  tag.includes(normalized)
                );
              } else {
                matches =
                  project.title.includes(normalized) ||
                  project.description.includes(normalized) ||
                  project.tags.some((tag) => tag.includes(normalized));
              }
            }

            project.element.classList.toggle(
              "project-card--hidden",
              !matches
            );
            if (matches) visibleCount++;
          });

          placeholderCards.forEach((card) => {
            card.classList.toggle("project-card--hidden", isFiltering);
          });

          grid?.classList.toggle("projects-grid--searching", isFiltering);

          if (emptyResults) {
            emptyResults.hidden = !isFiltering || visibleCount > 0;
          }
        };

        const STORAGE_KEY = "globalSearchQuery";
        const readStored = () => {
          try {
            return localStorage.getItem(STORAGE_KEY) || "";
          } catch {
            return "";
          }
        };

        const handleSearchChange = (event) => {
          const value =
            typeof event?.detail?.value === "string"
              ? event.detail.value
              : readStored();
          if (value?.trim() === "#") {
            applyFilter("");
            return;
          }
          applyFilter(value || "");
        };

        window.addEventListener("global-search-change", handleSearchChange);
        handleSearchChange({ detail: { value: readStored() } });
      })();
    </script>
  </body>
</html>
